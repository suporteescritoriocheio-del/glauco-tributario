---
// Minimal inline JavaScript for form validation and tracking
// Kept under 1KB for performance
---

<script is:inline>
    // Form validation
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("contact-form");
        if (form) {
            form.addEventListener("submit", function (e) {
                e.preventDefault();

                // Basic validation
                const nome = document.getElementById("nome").value.trim();
                const email = document.getElementById("email").value.trim();
                const telefone = document
                    .getElementById("telefone")
                    .value.trim();

                if (!nome || !email || !telefone) {
                    alert("Por favor, preencha todos os campos obrigatórios.");
                    return false;
                }

                // Email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert("Por favor, insira um e-mail válido.");
                    return false;
                }

                // Redirect to WhatsApp or submit form
                const mensagem = document
                    .getElementById("mensagem")
                    .value.trim();
                const cidade = document.getElementById("cidade").value.trim();
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;

                submitBtn.disabled = true;
                submitBtn.textContent = "ENVIANDO...";

                // Send data to API
                fetch("/api/capture-lead", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        name: nome,
                        email: email,
                        whatsapp: telefone,
                        city: cidade,
                        message: mensagem,
                        source: "Formulário de Contato",
                        timestamp: new Date().toISOString(),
                    }),
                })
                    .then((response) => {
                        if (response.ok) {
                            // Track conversion in Google Ads with callback
                            if (typeof gtag !== "undefined") {
                                gtag("event", "conversion", {
                                    send_to:
                                        "AW-11104417748/iB56COGH8eEaENTv_64p",
                                    event_callback: function () {
                                        // Redirect to WhatsApp after conversion is tracked
                                        const whatsappMsg = encodeURIComponent(
                                            `Olá! Gostaria de agendar uma consultoria.\n\nNome: ${nome}\nEmail: ${email}\nTelefone: ${telefone}\nMensagem: ${mensagem || "Não informado"}`,
                                        );
                                        window.location.href = `https://wa.me/5543991244440?text=${whatsappMsg}`;
                                    },
                                });
                                // Fallback timeout in case callback doesn't fire
                                setTimeout(() => {
                                    const whatsappMsg = encodeURIComponent(
                                        `Olá! Gostaria de agendar uma consultoria.\n\nNome: ${nome}\nEmail: ${email}\nTelefone: ${telefone}\nMensagem: ${mensagem || "Não informado"}`,
                                    );
                                    window.location.href = `https://wa.me/5543991244440?text=${whatsappMsg}`;
                                }, 1000);
                            } else {
                                // If gtag not available, redirect immediately
                                const whatsappMsg = encodeURIComponent(
                                    `Olá! Gostaria de agendar uma consultoria.\n\nNome: ${nome}\nEmail: ${email}\nTelefone: ${telefone}\nMensagem: ${mensagem || "Não informado"}`,
                                );
                                window.location.href = `https://wa.me/5543991244440?text=${whatsappMsg}`;
                            }
                        } else {
                            throw new Error("Erro no envio");
                        }
                    })
                    .catch((error) => {
                        console.error("Erro:", error);
                        alert(
                            "Erro ao enviar mensagem. Redirecionando para o WhatsApp...",
                        );
                        const whatsappMsg = encodeURIComponent(
                            `Olá! Gostaria de agendar uma consultoria.\n\nNome: ${nome}\nEmail: ${email}\nTelefone: ${telefone}\nMensagem: ${mensagem || "Não informado"}`,
                        );
                        window.location.href = `https://wa.me/5543991244440?text=${whatsappMsg}`;
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
            });
        }

        // WhatsApp CTA tracking
        const whatsappLinks = document.querySelectorAll(
            'a[href^="https://wa.me"]',
        );
        whatsappLinks.forEach(function (link) {
            link.addEventListener("click", function () {
                if (typeof gtag !== "undefined") {
                    gtag("event", "click", {
                        event_category: "engagement",
                        event_label: "whatsapp_cta",
                    });
                }
            });
        });
    });
</script>
